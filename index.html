<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Utilities Performance Dashboard</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
:root{
 --bg:#0b1220;
 --card:#111a2e;
 --text:#e8eefc;
 --accent:#00d9ff;
}

body{
 margin:0;
 font-family:Inter,Segoe UI,Arial;
 background:var(--bg);
 color:var(--text);
}

header{
 padding:16px 20px;
 font-size:20px;
 font-weight:600;
 background:#0f1830;
 border-bottom:1px solid #1f2a44;
}

/* ===== FILTER BAR ===== */
.filters{
 display:flex;
 gap:20px;
 padding:16px;
 background:#0f1830;
}

.filter{
 display:flex;
 flex-direction:column;
 gap:6px;
}

label{
 font-size:13px;
 opacity:.8;
}

/* IMPORTANT: visible multi-select */
select{
 background:#111a2e;
 color:var(--text);
 border:2px solid var(--accent);
 border-radius:8px;
 padding:6px;
 width:180px;
 font-size:14px;
}

select[multiple]{
 height:140px;
 box-shadow:0 0 0 3px rgba(0,217,255,.15);
}

/* ===== DASHBOARD ===== */
.dashboard{
 display:grid;
 grid-template-columns:repeat(auto-fit,minmax(350px,1fr));
 gap:20px;
 padding:20px;
}

.card{
 background:var(--card);
 border-radius:14px;
 padding:14px;
}

canvas{
 height:260px !important;
}
</style>
</head>

<body>

<header>Utilities Performance Dashboard</header>

<!-- ===== FILTERS ===== -->
<div class="filters">

 <div class="filter">
  <label>Year (Multi-Select)</label>
  <select id="yearSelect" multiple></select>
 </div>

 <div class="filter">
  <label>Project (Multi-Select)</label>
  <select id="projectSelect" multiple></select>
 </div>

</div>

<!-- ===== CHARTS ===== -->
<div class="dashboard">
 <div class="card"><canvas id="gtiChart"></canvas></div>
 <div class="card"><canvas id="mwhChart"></canvas></div>
</div>

<script>
const dataURL = "https://damp2011.github.io/utilities-dashboard/data.csv";

let rawData = [];
let selectedYears = [];
let selectedProjects = [];

let gtiChart, mwhChart;

/* ===== LOAD CSV ===== */
fetch(dataURL)
 .then(r => r.text())
 .then(text => {
  const rows = text.trim().split("\n").map(r => r.split(","));
  const h = rows.shift();

  rawData = rows.map(r=>{
   let o={};
   h.forEach((k,i)=>o[k.trim()] = r[i]?.trim());
   return o;
  });

  initFilters();
  renderCharts();
 });

/* ===== INIT FILTERS ===== */
function initFilters(){
 const years = [...new Set(rawData.map(d=>d.Date.split("-")[1]))];
 const projects = [...new Set(rawData.map(d=>d["Project name"]))];

 yearSelect.innerHTML = years.map(y=>`<option value="${y}">${y}</option>`).join("");
 projectSelect.innerHTML = projects.map(p=>`<option value="${p}">${p}</option>`).join("");

 enableClickMultiSelect(yearSelect);
 enableClickMultiSelect(projectSelect);
}

/* ===== CLICK MULTI-SELECT (NO CTRL) ===== */
function enableClickMultiSelect(sel){
 [...sel.options].forEach(o=>{
  o.addEventListener("mousedown",e=>{
   e.preventDefault();
   o.selected = !o.selected;
   sel.dispatchEvent(new Event("change"));
  });
 });
}

/* ===== FILTER EVENTS ===== */
yearSelect.onchange = ()=>{
 selectedYears = [...yearSelect.selectedOptions].map(o=>o.value);
 renderCharts();
};

projectSelect.onchange = ()=>{
 selectedProjects = [...projectSelect.selectedOptions].map(o=>o.value);
 renderCharts();
};

/* ===== FILTER DATA ===== */
function getFilteredData(){
 return rawData.filter(d=>{
  const y = d.Date.split("-")[1];
  return (selectedYears.length===0 || selectedYears.includes(y)) &&
         (selectedProjects.length===0 || selectedProjects.includes(d["Project name"]));
 });
}

/* ===== RENDER CHARTS ===== */
function renderCharts(){
 const d = getFilteredData();

 const labels = d.map(x=>x["Project name"]);
 const gti = d.map(x=>+x["Actual GTI"]);
 const mwh = d.map(x=>+x["Actual MWh"]);

 if(gtiChart) gtiChart.destroy();
 if(mwhChart) mwhChart.destroy();

 gtiChart = new Chart(document.getElementById("gtiChart"),{
  type:"bar",
  data:{labels,
   datasets:[{label:"Actual GTI",data:gti}]}
 });

 mwhChart = new Chart(document.getElementById("mwhChart"),{
  type:"bar",
  data:{labels,
   datasets:[{label:"Actual MWh",data:mwh}]}
 });
}
</script>

</body>
</html>
