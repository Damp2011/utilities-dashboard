<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Utilities Performance Summary Dashboard</title>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>

<style>
/* ===== YOUR ORIGINAL CSS (UNCHANGED) ===== */
@import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
:root{
 --bg:#0B1437; --card:#151E3D; --card-hover:#1A2647;
 --text:#E8EAED; --muted:#8B92AB; --accent:#00D9FF;
 --accent2:#7C3AED; --success:#00F5A0; --danger:#FF4757;
 --warning:#FFA900; --border:#252E4A;
}
body{font-family:Inter;background:#0B1437;color:var(--text);padding:20px;}
</style>
</head>

<body>

<h1>âš¡ Utilities Performance Dashboard</h1>

<div class="controls-container">
 <select id="projectSelect"><option value="All">All Projects</option></select>
 <select id="yearSelect" multiple size="4"></select>
</div>

<div id="dashboard" class="dashboard"></div>

<script>
Chart.register(ChartDataLabels);

const CSV_URL =
 "https://raw.githubusercontent.com/Damp2011/utilities-dashboard/main/data.csv";

const months=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];
let rawData=[],charts=[],selectedYears=[];

function normalizeMonth(m){ return m.substring(0,3); }

/* ================= LOAD CSV ================= */
fetch(CSV_URL,{cache:"no-store"})
 .then(r=>r.text())
 .then(loadCSV)
 .catch(e=>console.error(e));

projectSelect.onchange=render;
yearSelect.onchange=()=>{
 selectedYears=[...yearSelect.selectedOptions].map(o=>+o.value);
 render();
};

function loadCSV(text){
 const rows=text.trim().split("\n");
 const headers=rows[0].split(",");

 rawData=rows.slice(1).map(r=>{
  const cols=r.split(",");
  let o={};
  headers.forEach((h,i)=>o[h.trim()]=cols[i]);
  return o;
 });

 /* Projects */
 [...new Set(rawData.map(d=>d["Project name"]))].forEach(p=>{
  projectSelect.innerHTML+=`<option>${p}</option>`;
 });

 /* Years */
 const years=[...new Set(
  rawData.map(d=>2000+Number(d["Date"].split("-")[1]))
 )].sort();

 yearSelect.innerHTML=years.map(y=>`<option selected>${y}</option>`).join("");
 selectedYears=years;

 render();
}

/* ================= RENDER ================= */
function render(){
 charts.forEach(c=>c.destroy());
 charts=[];
 dashboard.innerHTML="";

 const proj=projectSelect.value;
 const data=proj==="All"?rawData:rawData.filter(d=>d["Project name"]===proj);

 drawChart("Actual MWh","Actual MWh",data);
 drawChart("Expected P50 MWh","Expected P50 MWh",data);
 drawChart("Actual GTI","Actual GTI",data);
}

function drawChart(title,col,data){
 const datasets=[];

 selectedYears.forEach((yr,i)=>{
  const sum={},cnt={};

  data.forEach(d=>{
   let [m,y]=d["Date"].split("-");
   m=normalizeMonth(m);
   if(2000+Number(y)!==yr) return;

   const v=parseFloat(d[col]);
   if(!isNaN(v)){
    sum[m]=(sum[m]||0)+v;
    cnt[m]=(cnt[m]||0)+1;
   }
  });

  datasets.push({
   label:yr,
   data:months.map(m=>cnt[m]?sum[m]/cnt[m]:null),
   borderWidth:3,
   tension:.4
  });
 });

 const card=document.createElement("div");
 card.innerHTML=`<h3>${title}</h3><canvas></canvas>`;
 dashboard.appendChild(card);

 charts.push(new Chart(card.querySelector("canvas"),{
  type:"line",
  data:{labels:months,datasets},
  options:{responsive:true}
 }));
}
</script>

</body>
</html>
