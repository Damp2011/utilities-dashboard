<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Utilities Performance Dashboard</title>

<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>

<style>
body{
 margin:0;
 font-family:Inter,Segoe UI,Arial;
 background:#0B1437;
 color:#E8EAED;
 padding:20px;
}
h1{
 text-align:center;
 margin-bottom:5px;
 background:linear-gradient(90deg,#00D9FF,#7C3AED,#00F5A0);
 -webkit-background-clip:text;
 -webkit-text-fill-color:transparent;
}
.subtitle{
 text-align:center;
 color:#8B92AB;
 margin-bottom:30px;
}
.controls{
 max-width:1300px;
 margin:0 auto 20px;
 display:flex;
 gap:20px;
 flex-wrap:wrap;
}
select{
 background:#151E3D;
 color:#E8EAED;
 border:1px solid #252E4A;
 padding:10px;
 border-radius:8px;
 min-width:200px;
}
.dashboard{
 max-width:1300px;
 margin:0 auto;
 display:grid;
 grid-template-columns:repeat(auto-fit,minmax(500px,1fr));
 gap:20px;
}
.card{
 background:#151E3D;
 border:1px solid #252E4A;
 border-radius:16px;
 padding:20px;
}
canvas{max-height:360px;}
</style>
</head>

<body>

<h1>âš¡ Utilities Performance Dashboard</h1>
<p class="subtitle">Auto-loaded from GitHub CSV</p>

<div class="controls">
 <select id="projectSelect">
  <option value="All">All Projects</option>
 </select>

 <select id="yearSelect" multiple size="4"></select>
</div>

<div class="dashboard" id="dashboard"></div>

<script>
Chart.register(ChartDataLabels);

const RAW_CSV_URL =
 "https://raw.githubusercontent.com/Damp2011/utilities-dashboard/main/data.csv";

const months=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];
const colors=["#00D9FF","#7C3AED","#00F5A0","#FFA900","#FF4757","#6366F1"];

let rawData=[];
let charts=[];
let selectedYears=[];

/* =========================
   LOAD DATA FROM GITHUB
========================= */
fetch(RAW_CSV_URL,{cache:"no-store"})
 .then(r=>r.text())
 .then(loadCSV)
 .catch(err=>{
  console.error(err);
  alert("Failed to load CSV from GitHub");
 });

projectSelect.onchange=render;
yearSelect.onchange=()=>{
 selectedYears=[...yearSelect.selectedOptions].map(o=>+o.value);
 render();
};

function loadCSV(text){
 const rows=text.trim().split("\n");
 const headers=rows[0].split(",");

 rawData=rows.slice(1).map(r=>{
  const cols=r.split(",");
  let o={};
  headers.forEach((h,i)=>o[h.trim()]=cols[i]);
  return o;
 });

 /* Populate Project Filter */
 [...new Set(rawData.map(d=>d["Project name"]))].forEach(p=>{
  projectSelect.innerHTML+=`<option>${p}</option>`;
 });

 /* Populate Year Filter */
 const years=[...new Set(
  rawData.map(d=>2000+Number(d["Date"].slice(-2)))
 )].sort();

 yearSelect.innerHTML=years
  .map(y=>`<option selected value="${y}">${y}</option>`)
  .join("");

 selectedYears=years;
 render();
}

/* =========================
   RENDER DASHBOARD
========================= */
function render(){
 charts.forEach(c=>c.destroy());
 charts=[];
 dashboard.innerHTML="";

 if(!selectedYears.length) return;

 const proj=projectSelect.value;
 const data=proj==="All"
  ? rawData
  : rawData.filter(d=>d["Project name"]===proj);

 drawLine("Actual MWh",data,"Actual MWh");
 drawLine("Expected P50 MWh",data,"Expected P50 MWh");
 drawLine("Actual GTI",data,"Actual GTI");
}

/* =========================
   CHART FUNCTION
========================= */
function drawLine(title,data,column){
 const datasets=[];

 selectedYears.forEach((yr,i)=>{
  let sum={},cnt={};

  data.forEach(d=>{
   const [m,y]=d["Date"].split("-");
   if(2000+Number(y)!==yr) return;

   const v=parseFloat(d[column]);
   if(!isNaN(v)){
    sum[m]=(sum[m]||0)+v;
    cnt[m]=(cnt[m]||0)+1;
   }
  });

  datasets.push({
   label:String(yr),
   data:months.map(m=>cnt[m]?sum[m]/cnt[m]:null),
   borderColor:colors[i%colors.length],
   backgroundColor:colors[i%colors.length]+"33",
   tension:0.4,
   fill:true,
   pointRadius:4,
   borderWidth:3
  });
 });

 const card=document.createElement("div");
 card.className="card";
 card.innerHTML=`<h3>${title}</h3><canvas></canvas>`;
 dashboard.appendChild(card);

 charts.push(new Chart(card.querySelector("canvas"),{
  type:"line",
  data:{labels:months,datasets},
  options:{
   responsive:true,
   plugins:{
    legend:{labels:{color:"#E8EAED"}},
    datalabels:{display:false}
   },
   scales:{
    x:{ticks:{color:"#8B92AB"}},
    y:{ticks:{color:"#8B92AB"}}
   }
  }
 }));
}
</script>

</body>
</html>
