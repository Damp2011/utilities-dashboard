<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Utilities Performance Summary Dashboard</title>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

<style>
@import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');

body{
 font-family:Inter;
 background:#0B1437;
 color:#E8EAED;
 margin:0;
 padding:20px;
}
.controls-container{
 display:flex;
 gap:10px;
 margin-bottom:20px;
}
.dashboard{
 display:grid;
 grid-template-columns:repeat(auto-fit,minmax(420px,1fr));
 gap:20px;
}
.card{
 background:#151E3D;
 padding:15px;
 border-radius:10px;
}
</style>
</head>

<body>

<h2>âš¡ Utilities Performance Dashboard</h2>

<div class="controls-container">
 <select id="projectSelect">
  <option value="All">All Projects</option>
 </select>

 <select id="yearSelect" multiple size="4"></select>
</div>

<div id="dashboard" class="dashboard"></div>

<script>
Chart.register(ChartDataLabels);

const CSV_URL =
 "https://raw.githubusercontent.com/Damp2011/utilities-dashboard/main/data.csv";

const months=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];
let rawData=[],charts=[],selectedYears=[];

/* ===== LOAD CSV (ROBUST) ===== */
Papa.parse(CSV_URL,{
 download:true,
 header:true,
 skipEmptyLines:true,
 complete:(res)=>{
  rawData=res.data;
  initFilters();
  render();
 }
});

/* ===== FILTERS ===== */
projectSelect.onchange=render;
yearSelect.onchange=()=>{
 selectedYears=[...yearSelect.selectedOptions].map(o=>+o.value);
 render();
};

function initFilters(){
 [...new Set(rawData.map(d=>d["Project name"]))].forEach(p=>{
  projectSelect.innerHTML+=`<option>${p}</option>`;
 });

 const years=[...new Set(
  rawData.map(d=>2000+Number(d["Date"].split("-")[1]))
 )].sort();

 yearSelect.innerHTML=years.map(y=>`<option selected>${y}</option>`).join("");
 selectedYears=years;
}

/* ===== RENDER ===== */
function render(){
 charts.forEach(c=>c.destroy());
 charts=[];
 dashboard.innerHTML="";

 const proj=projectSelect.value;
 const data=proj==="All"?rawData:rawData.filter(d=>d["Project name"]===proj);

 drawChart("Actual MWh","Actual MWh",data);
 drawChart("Expected P50 MWh","Expected P50 MWh",data);
 drawChart("Actual GTI","Actual GTI",data);
}

/* ===== CHART ===== */
function drawChart(title,col,data){
 const datasets=[];

 selectedYears.forEach(yr=>{
  const sum={},cnt={};

  data.forEach(d=>{
   if(!d[col]) return;

   let [m,y]=d["Date"].split("-");
   m=m.substring(0,3);
   if(2000+Number(y)!==yr) return;

   const v=parseFloat(d[col]);
   if(!isNaN(v)){
    sum[m]=(sum[m]||0)+v;
    cnt[m]=(cnt[m]||0)+1;
   }
  });

  datasets.push({
   label:yr,
   data:months.map(m=>cnt[m]?sum[m]/cnt[m]:null),
   tension:.4,
   borderWidth:3
  });
 });

 const card=document.createElement("div");
 card.className="card";
 card.innerHTML=`<h3>${title}</h3><canvas></canvas>`;
 dashboard.appendChild(card);

 charts.push(new Chart(card.querySelector("canvas"),{
  type:"line",
  data:{labels:months,datasets},
  options:{responsive:true}
 }));
}
</script>

</body>
</html>
