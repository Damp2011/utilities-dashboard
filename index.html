<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Utilities Performance Dashboard</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

<style>
body{
 margin:0;
 font-family: Inter, Segoe UI, Arial;
 background: linear-gradient(135deg,#0b1220,#08101a);
 color:#eaf6ff;
}

header{
 padding:20px 30px;
 font-size:22px;
 font-weight:600;
 border-bottom:1px solid rgba(255,255,255,.1);
}

.filters{
 display:flex;
 gap:20px;
 padding:20px 30px;
}

.filter-box{
 display:flex;
 flex-direction:column;
 gap:6px;
}

label{
 font-size:13px;
 opacity:.9;
}

select[multiple]{
 min-width:180px;
 min-height:120px;
 background:#0f1a2b;
 color:#eaf6ff;
 border:2px solid #00e5ff;
 border-radius:8px;
 padding:6px;
 outline:none;
}

.dashboard{
 display:grid;
 grid-template-columns:1fr 1fr;
 gap:20px;
 padding:20px 30px;
}

.card{
 background:linear-gradient(180deg,#101b2f,#0b1424);
 border-radius:16px;
 padding:16px;
 box-shadow:0 20px 50px rgba(0,0,0,.4);
}

canvas{
 width:100%!important;
 height:300px!important;
}
</style>
</head>

<body>

<header>Utilities Performance Dashboard</header>

<div class="filters">
 <div class="filter-box">
  <label>Year (Multi-Select)</label>
  <select id="yearSelect" multiple></select>
 </div>

 <div class="filter-box">
  <label>Project (Multi-Select)</label>
  <select id="projectSelect" multiple></select>
 </div>
</div>

<div class="dashboard">
 <div class="card">
  <canvas id="gtiChart"></canvas>
 </div>
 <div class="card">
  <canvas id="mwhChart"></canvas>
 </div>
</div>

<script>
let rawData=[];
let selectedYears=[];
let selectedProjects=[];
let gtiChart,mwhChart;

const yearSelect=document.getElementById("yearSelect");
const projectSelect=document.getElementById("projectSelect");

/* -------- MULTI-CLICK (NO CTRL) -------- */
function enableClickMultiSelect(select){
 [...select.options].forEach(opt=>{
  opt.addEventListener("mousedown",e=>{
   e.preventDefault();
   opt.selected=!opt.selected;
   select.dispatchEvent(new Event("change"));
  });
 });
}

/* -------- FILTER DATA -------- */
function getFilteredData(){
 return rawData.filter(d=>{
  if(!d.Date || !d["Project name"]) return false;
  const year=d.Date.trim().slice(-2);
  return (
   (selectedYears.length===0 || selectedYears.includes(year)) &&
   (selectedProjects.length===0 || selectedProjects.includes(d["Project name"]))
  );
 });
}

/* -------- POPULATE FILTERS -------- */
function populateFilters(){
 const years=[...new Set(
  rawData.filter(d=>d.Date).map(d=>d.Date.trim().slice(-2))
 )].sort();

 const projects=[...new Set(
  rawData.map(d=>d["Project name"]).filter(Boolean)
 )].sort();

 yearSelect.innerHTML=years.map(y=>`<option value="${y}">${y}</option>`).join("");
 projectSelect.innerHTML=projects.map(p=>`<option value="${p}">${p}</option>`).join("");

 enableClickMultiSelect(yearSelect);
 enableClickMultiSelect(projectSelect);
}

/* -------- RENDER CHARTS -------- */
function render(){
 const data=getFilteredData();

 const labels=data.map(d=>d.Date);

 const actualGTI=data.map(d=>+d["Actual GTI"]||0);
 const actualMWh=data.map(d=>+d["Actual MWh"]||0);
 const p50=data.map(d=>+d["Expected P50 MWh"]||0);
 const p90=data.map(d=>+d["Expected P90 MWh"]||0);

 if(gtiChart) gtiChart.destroy();
 if(mwhChart) mwhChart.destroy();

 gtiChart=new Chart(document.getElementById("gtiChart"),{
  type:"line",
  data:{
   labels,
   datasets:[{
    label:"Actual GTI",
    data:actualGTI,
    borderWidth:3,
    tension:.35
   }]
  },
  options:{responsive:true,plugins:{legend:{labels:{color:"#eaf6ff"}}}}
 });

 mwhChart=new Chart(document.getElementById("mwhChart"),{
  type:"bar",
  data:{
   labels,
   datasets:[
    {label:"Actual MWh",data:actualMWh},
    {label:"Expected P50",data:p50},
    {label:"Expected P90",data:p90}
   ]
  },
  options:{responsive:true,plugins:{legend:{labels:{color:"#eaf6ff"}}}}
 });
}

/* -------- EVENTS -------- */
yearSelect.onchange=()=>{
 selectedYears=[...yearSelect.selectedOptions].map(o=>o.value);
 render();
};

projectSelect.onchange=()=>{
 selectedProjects=[...projectSelect.selectedOptions].map(o=>o.value);
 render();
};

/* -------- LOAD CSV -------- */
Papa.parse("data.csv",{
 download:true,
 header:true,
 skipEmptyLines:true,
 complete:(res)=>{
  rawData=res.data;
  populateFilters();
  render();
 }
});
</script>

</body>
</html>
