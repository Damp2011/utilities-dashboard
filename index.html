<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Utilities Performance Dashboard</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
body{
 margin:0;
 font-family:Inter,Segoe UI,Arial;
 background:linear-gradient(135deg,#2b1055,#0f766e);
 color:#e5e7eb;
}
.header{text-align:center;padding:30px}
.header h1{
 font-size:34px;
 background:linear-gradient(90deg,#60a5fa,#a855f7,#22d3ee);
 -webkit-background-clip:text;
 -webkit-text-fill-color:transparent;
}
.filters{
 display:flex;gap:14px;justify-content:center;margin-bottom:20px
}
select{
 background:#1f2937;color:white;
 border:none;padding:10px 14px;border-radius:10px
}
.grid{
 display:grid;
 grid-template-columns:repeat(auto-fit,minmax(380px,1fr));
 gap:20px;padding:20px
}
.card{
 background:rgba(255,255,255,.08);
 border-radius:18px;padding:16px
}
.card h3{margin:0 0 10px;font-size:15px;color:white;}
canvas{height:260px}
</style>
</head>
<body>

<div class="header">
 <h1>⚡ Utilities Performance Dashboard</h1>
</div>

<div class="filters">
 <select id="yearFilter"></select>
 <select id="projectFilter"></select>
</div>

<div class="grid">
 <div class="card"><h3>Expected P50 vs Actual MWh</h3><canvas id="c1"></canvas></div>
 <div class="card"><h3>Actual MWh & GTI Comparison</h3><canvas id="c2"></canvas></div>
 <div class="card"><h3>WC Achieved (Year over Year)</h3><canvas id="c3"></canvas></div>
 <div class="card"><h3>WC_NOC with Delta (Month-over-Month)</h3><canvas id="c4"></canvas></div>
 <div class="card"><h3>Act. GA (%) – Threshold: 99.5%</h3><canvas id="c5"></canvas></div>
 <div class="card"><h3>Act. PA (%) – Threshold: 99.5%</h3><canvas id="c6"></canvas></div>
</div>

<script>
const charts = {}, TH = 99.5;

// Fetch CSV
fetch("data.csv?v="+Date.now()).then(r=>r.text()).then(t=>{
 const rows = t.trim().split("\n");
 const headers = rows.shift().split(",");
 const data = rows.map(r=>{
   const obj = {};
   r.split(",").forEach((v,i)=>{
     const key = headers[i];
     const num = v.replace('%','').trim();
     obj[key] = !isNaN(num) && num !== '' ? parseFloat(num) : v;
   });
   return obj;
 });

 // Populate filters
 const years = [...new Set(data.map(d=>"20"+d.Date.split("-")[1]))];
 yearFilter.innerHTML = '<option value="">All Years</option>'+years.map(y=>`<option>${y}</option>`).join("");
 projectFilter.innerHTML = '<option value="">All Projects</option>'+
   [...new Set(data.map(d=>d["Project name"]))].map(p=>`<option>${p}</option>`).join("");

 yearFilter.onchange = projectFilter.onchange = ()=>render(data);
 render(data);
});

function render(raw){
 Object.values(charts).forEach(c=>c.destroy());
 const y = yearFilter.value, p = projectFilter.value;
 const filtered = raw.filter(d=>(!y||("20"+d.Date.split("-")[1])===y)&&(!p||d["Project name"]===p));
 const months = [...new Set(filtered.map(d=>d.Date))];

 const sum = key => months.map(M => filtered.filter(d=>d.Date===M).reduce((s,x)=>s+(+x[key]||0),0));
 const avg = key => months.map(M => {
   const a = filtered.filter(d=>d.Date===M).map(x=>+x[key]||0);
   return a.reduce((s,v)=>s+v,0)/a.length;
 });

 const commonOptions = {
   plugins:{legend:{labels:{color:"white"}}},
   scales:{
     x:{ticks:{color:"white"}, grid:{color:"rgba(255,255,255,0.1)"}},
     y:{ticks:{color:"white"}, grid:{color:"rgba(255,255,255,0.1)"}}
   }
 };

 // Chart 1
 charts.c1 = new Chart(c1,{
   type:"bar",
   data:{
     labels:months,
     datasets:[
       {label:"Expected P50",data:sum("Expected P50 MWh"),backgroundColor:"#60a5fa"},
       {label:"Actual",data:sum("Actual MWh"),backgroundColor:"#22d3ee"}
     ]
   },
   options:commonOptions
 });

 // Chart 2 (Actual GTI line)
 charts.c2 = new Chart(c2,{
   data:{
     labels:months,
     datasets:[
       {type:"bar",label:"Actual MWh",data:sum("Actual MWh"),yAxisID:"y",backgroundColor:"#facc15"},
       {type:"line",label:"Actual GTI",data:avg("Actual GTI"),yAxisID:"y1",borderColor:"#f87171",tension:0.3,fill:false,pointBackgroundColor:"#f87171"}
     ]
   },
   options:{
     plugins:{legend:{labels:{color:"white"}}},
     scales:{
       y:{beginAtZero:true,ticks:{color:"white"}, grid:{color:"rgba(255,255,255,0.1)"}},
       y1:{position:"right",ticks:{color:"white"}, grid:{color:"rgba(255,255,255,0.1)"}},
       x:{ticks:{color:"white"}, grid:{color:"rgba(255,255,255,0.1)"}}
     }
   }
 });

 // Chart 3
 charts.c3 = new Chart(c3,{
   type:"line",
   data:{labels:months,datasets:[
     {label:"WC Achieved",data:avg("WC Achieved"),borderColor:"#22d3ee",tension:0.3,fill:false,pointBackgroundColor:"#22d3ee"}
   ]},
   options:commonOptions
 });

 // Chart 4
 charts.c4 = new Chart(c4,{
   type:"line",
   data:{labels:months,datasets:[
     {label:"WC_NOC",data:avg("WC_NOC"),borderColor:"#a855f7",tension:0.3,fill:false,pointBackgroundColor:"#a855f7"}
   ]},
   options:commonOptions
 });

 // Chart 5 GA
 charts.c5 = new Chart(c5,{
   type:"line",
   data:{labels:months,datasets:[
     {label:"GA",data:avg("Act. GA (%)"),borderColor:"#22d3ee",tension:0.3,fill:false,
      pointBackgroundColor:avg("Act. GA (%)").map(v=>v<TH?"#ef4444":"#22d3ee")}
   ]},
   options:commonOptions
 });

 // Chart 6 PA
 charts.c6 = new Chart(c6,{
   type:"line",
   data:{labels:months,datasets:[
     {label:"PA",data:avg("Act. PA (%)"),borderColor:"#60a5fa",tension:0.3,fill:false,
      pointBackgroundColor:avg("Act. PA (%)").map(v=>v<TH?"#ef4444":"#60a5fa")}
   ]},
   options:commonOptions
 });
}
</script>
</body>
</html>
