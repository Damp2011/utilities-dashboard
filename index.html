<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Utilities Performance Dashboard</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
body{
 margin:0;
 font-family:Inter,Segoe UI,Arial;
 background:linear-gradient(135deg,#2b1055,#0f766e);
 color:#e5e7eb;
}
.header{text-align:center;padding:30px}
.header h1{
 font-size:34px;
 background:linear-gradient(90deg,#60a5fa,#a855f7,#22d3ee);
 -webkit-background-clip:text;
 -webkit-text-fill-color:transparent;
}
.filters{
 display:flex;gap:14px;justify-content:center;margin-bottom:20px
}
select{
 background:#1f2937;color:white;
 border:none;padding:10px 14px;border-radius:10px
}
.grid{
 display:grid;
 grid-template-columns:repeat(auto-fit,minmax(380px,1fr));
 gap:20px;padding:20px
}
.card{
 background:rgba(255,255,255,.08);
 border-radius:18px;padding:16px
}
.card h3{margin:0 0 10px;font-size:15px}
canvas{height:260px}
</style>
</head>

<body>

<div class="header">
 <h1>⚡ Utilities Performance Dashboard</h1>
</div>

<div class="filters">
 <select id="yearFilter"></select>
 <select id="projectFilter"></select>
</div>

<div class="grid">
 <div class="card"><h3>Expected P50 vs Actual MWh</h3><canvas id="c1"></canvas></div>
 <div class="card"><h3>Actual MWh & GTI Comparison</h3><canvas id="c2"></canvas></div>
 <div class="card"><h3>WC Achieved (Year over Year)</h3><canvas id="c3"></canvas></div>
 <div class="card"><h3>WC_NOC with Delta (Month-over-Month)</h3><canvas id="c4"></canvas></div>
 <div class="card"><h3>Act. GA (%) – Threshold: 99.5%</h3><canvas id="c5"></canvas></div>
 <div class="card"><h3>Act. PA (%) – Threshold: 99.5%</h3><canvas id="c6"></canvas></div>
</div>

<script>
const charts={}, TH=99.5;
fetch("data.csv?v="+Date.now()).then(r=>r.text()).then(t=>{
 const rows=t.trim().split("\n");
 const h=rows.shift().split(",");
 const data=rows.map(r=>{
  const o={}; r.split(",").forEach((v,i)=>o[h[i]]=v); return o;
 });

 const years=[...new Set(data.map(d=>"20"+d.Date.split("-")[1]))];
 yearFilter.innerHTML='<option value="">All Years</option>'+years.map(y=>`<option>${y}</option>`).join("");
 projectFilter.innerHTML='<option value="">All Projects</option>'+
 [...new Set(data.map(d=>d["Project name"]))].map(p=>`<option>${p}</option>`).join("");

 yearFilter.onchange=projectFilter.onchange=()=>render(data);
 render(data);
});

function render(raw){
 Object.values(charts).forEach(c=>c.destroy());
 const y=yearFilter.value,p=projectFilter.value;

 const f=raw.filter(d=>
  (!y||("20"+d.Date.split("-")[1])===y)&&(!p||d["Project name"]===p)
 );

 const m=[...new Set(f.map(d=>d.Date))];
 const sum=k=>m.map(M=>f.filter(d=>d.Date===M).reduce((s,x)=>s+(+x[k]||0),0));
 const avg=k=>m.map(M=>{
  const a=f.filter(d=>d.Date===M).map(x=>+x[k]||0);
  return a.reduce((s,v)=>s+v,0)/a.length;
 });

 charts.c1=new Chart(c1,{type:"bar",data:{labels:m,datasets:[
  {label:"Expected P50",data:sum("Expected P50 MWh")},
  {label:"Actual",data:sum("Actual MWh")}
 ]}});

 charts.c2=new Chart(c2,{data:{labels:m,datasets:[
  {type:"bar",label:"MWh",data:sum("Actual MWh"),yAxisID:"y"},
  {type:"line",label:"GTI",data:avg("GTI Achieved"),yAxisID:"y1"}
 ]},
 options:{scales:{y:{beginAtZero:true},y1:{position:"right"}}}});

 charts.c3=new Chart(c3,{type:"line",data:{labels:m,datasets:[
  {label:"WC Achieved",data:avg("WC Achieved")}
 ]}});

 charts.c4=new Chart(c4,{type:"line",data:{labels:m,datasets:[
  {label:"WC_NOC",data:avg("WC_NOC")}
 ]}});

 charts.c5=new Chart(c5,{type:"line",data:{labels:m,datasets:[
  {label:"GA",data:avg("Act. GA (%)"),
   pointBackgroundColor:avg("Act. GA (%)").map(v=>v<TH?"#ef4444":"#22d3ee")}
 ]}});

 charts.c6=new Chart(c6,{type:"line",data:{labels:m,datasets:[
  {label:"PA",data:avg("Act. PA (%)"),
   pointBackgroundColor:avg("Act. PA (%)").map(v=>v<TH?"#ef4444":"#22d3ee")}
 ]}});
}
</script>
</body>
</html>
