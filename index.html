<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Utilities Performance Summary Dashboard</title>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>

<style>
@import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');

:root{
 --bg:#050814;
 --card:#0D1525;
 --card-hover:#111B2E;
 --text:#F0F4F8;
 --muted:#7C8BA1;
 --accent:#00E5FF;
 --accent2:#9D4EDD;
 --accent3:#06FFA5;
 --border:#1A2332;
}

*{margin:0;padding:0;box-sizing:border-box}

body{
 font-family:'Inter',sans-serif;
 background:var(--bg);
 color:var(--text);
 min-height:100vh;
 padding:20px;
}

.header{text-align:center;margin-bottom:30px}
h1{
 font-size:2.5rem;
 background:linear-gradient(135deg,var(--accent),var(--accent2),var(--accent3));
 -webkit-background-clip:text;
 -webkit-text-fill-color:transparent;
}
.subtitle{color:var(--muted)}

.controls-container{
 max-width:1400px;
 margin:0 auto 25px;
 background:var(--card);
 border:1px solid var(--border);
 border-radius:16px;
 padding:20px;
}

.controls{
 display:grid;
 grid-template-columns:repeat(auto-fit,minmax(240px,1fr));
 gap:20px;
}

.control-group{display:flex;flex-direction:column;gap:8px}

.control-label{
 font-size:.75rem;
 text-transform:uppercase;
 letter-spacing:1px;
 color:var(--accent);
 font-weight:700;
}

select{
 background:#121A2F;
 color:var(--text);
 border:1px solid var(--border);
 padding:10px 14px;
 border-radius:10px;
 font-size:.9rem;
}

.dashboard{
 max-width:1600px;
 margin:0 auto;
 display:grid;
 grid-template-columns:repeat(3,1fr);
 gap:20px;
}

.card{
 background:#0E1628;
 border:1px solid var(--border);
 border-radius:18px;
 padding:20px;
}

.card h3{
 margin-bottom:15px;
 font-size:1rem;
 color:var(--accent);
}

@media(max-width:1200px){.dashboard{grid-template-columns:repeat(2,1fr)}}
@media(max-width:800px){.dashboard{grid-template-columns:1fr}}
</style>
</head>

<body>

<div class="header">
 <h1>âš¡ Utilities Performance Dashboard</h1>
 <p class="subtitle">Auto-loaded from GitHub Pages</p>
</div>

<div class="controls-container">
 <div class="controls">
  <div class="control-group">
   <label class="control-label">Project</label>
   <select id="projectSelect"><option value="All">All Projects</option></select>
  </div>
  <div class="control-group">
   <label class="control-label">Year</label>
   <select id="yearSelect" multiple size="4"></select>
  </div>
 </div>
</div>

<div id="dashboard" class="dashboard"></div>

<script>
Chart.register(ChartDataLabels);
Chart.defaults.font.family="'Inter',sans-serif";

const months=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];

const CSV_URL="https://damp2011.github.io/utilities-dashboard/data.csv";

const colorPalette=[
 "#00E5FF","#9D4EDD","#06FFA5","#FFB800","#FF3B6D","#6366F1"
];

let rawData=[],charts=[],selectedYears=[];

const monthMap={Jan:"Jan",Feb:"Feb",Mar:"Mar",Apr:"Apr",May:"May",Jun:"Jun",Jul:"Jul",Aug:"Aug",Sep:"Sep",Oct:"Oct",Nov:"Nov",Dec:"Dec"};

function parseDate(d){
 const [m,y]=d.trim().split("-");
 return{month:monthMap[m],year:2000+Number(y)};
}

/* -------- LOAD CSV FROM GITHUB -------- */
window.addEventListener("load",()=>{
 fetch(CSV_URL,{cache:"no-store"})
  .then(r=>r.text())
  .then(loadCSV)
  .catch(()=>{
   dashboard.innerHTML=`<div class="card"><h3>Error</h3><p style="color:#FF3B6D">data.csv not found on GitHub</p></div>`;
  });
});

projectSelect.onchange=render;
yearSelect.onchange=()=>{
 selectedYears=[...yearSelect.selectedOptions].map(o=>+o.value);
 render();
};

function loadCSV(text){
 const rows=text.trim().split("\n");
 const h=rows[0].split(",");
 rawData=rows.slice(1).map(r=>{
  const c=r.split(",");
  let o={};h.forEach((k,i)=>o[k.trim()]=c[i]);
  return o;
 });

 projectSelect.innerHTML='<option value="All">All Projects</option>';
 [...new Set(rawData.map(d=>d["Project name"]))].forEach(p=>{
  projectSelect.innerHTML+=`<option>${p}</option>`;
 });

 const years=[...new Set(rawData.map(d=>parseDate(d["Date"]).year))].sort();
 yearSelect.innerHTML=years.map(y=>`<option selected value="${y}">${y}</option>`).join("");
 selectedYears=years;

 render();
}

function render(){
 charts.forEach(c=>c.destroy());
 charts=[];
 dashboard.innerHTML="";

 const proj=projectSelect.value;
 const data=proj==="All"?rawData:rawData.filter(d=>d["Project name"]===proj);

 actualMWh(data);
}

function actualMWh(data){
 const datasets=[];
 selectedYears.forEach((yr,i)=>{
  const vals={};
  data.forEach(d=>{
   const {month,year}=parseDate(d["Date"]);
   if(year!==yr)return;
   const v=parseFloat(d["Actual MWh"]);
   if(!isNaN(v))vals[month]=(vals[month]||0)+v;
  });

  datasets.push({
   label:`Actual MWh ${yr}`,
   data:months.map(m=>vals[m]||null),
   backgroundColor:colorPalette[i%colorPalette.length]
  });
 });

 addBar("Actual MWh",datasets);
}

function addBar(title,datasets){
 const c=document.createElement("div");
 c.className="card";
 c.innerHTML=`<h3>${title}</h3><canvas></canvas>`;
 dashboard.appendChild(c);

 charts.push(new Chart(c.querySelector("canvas"),{
  type:"bar",
  data:{labels:months,datasets},
  options:{responsive:true,plugins:{legend:{labels:{color:"#fff"}}}}
 }));
}
</script>
</body>
</html>
